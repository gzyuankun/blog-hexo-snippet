<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="勾三股四">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.3.0">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://snippet.itshare.work">
    <!--SEO-->

<meta name="keywords" content="" />


<meta name="description" content="Playbookplaybook介绍官方链接
1https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html

..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    运维自动化工具Ansible(二) |
    
    勾三股四
</title>

<link rel="alternate" href="/atom.xml" title="勾三股四" type="application/atom+xml">


<link rel="icon" href="./img/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/./img/favicon.ico.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 6.3.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    /./img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='yuan kun'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <h2>
                深夜是学习的粥
            </h2>
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://snippet.itshare.work">
                        勾三股四</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories"><i class="fa "></i>
                                分类</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/tags"><i class="fa "></i>
                                标签</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/about"><i class="fa "></i>
                                关于</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="运维自动化工具Ansible(二)">
            
            运维自动化工具Ansible(二)
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/Ansible/">Ansible</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2023/02/25</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="Playbook"><a href="#Playbook" class="headerlink" title="Playbook"></a>Playbook</h1><h2 id="playbook介绍"><a href="#playbook介绍" class="headerlink" title="playbook介绍"></a>playbook介绍</h2><p>官方链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html</span><br></pre></td></tr></table></figure>

<h3 id="Playbook-组成"><a href="#Playbook-组成" class="headerlink" title="Playbook 组成"></a>Playbook 组成</h3><p><img src="/../image.assets/1677299110747.png" alt="1677299110747"></p>
<ul>
<li>一个 playbook(剧本)文件是一个YAML语言编写的文本文件</li>
<li>通常一个playbook只包括一个play</li>
<li>一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。</li>
<li>一个tasks中可以有一个或多个task任务</li>
<li>每一个Task本质上就是调用ansible的一个module</li>
<li>在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务</li>
</ul>
<h3 id="Playbook-与-Ad-Hoc-对比"><a href="#Playbook-与-Ad-Hoc-对比" class="headerlink" title="Playbook 与 Ad-Hoc 对比"></a>Playbook 与 Ad-Hoc 对比</h3><ul>
<li>Playbook是对多个 AD-Hoc 的一种编排组合的实现方式</li>
<li>Playbook能控制任务执行的先后顺序</li>
<li>Playbook可以持久保存到文件中从而方便多次调用运行，而Ad-Hoc只能临时运行。</li>
<li>Playbook适合复杂的重复性的任务，而Ad-Hoc适合做快速简单的一次性任务</li>
</ul>
<h2 id="YAML-语言"><a href="#YAML-语言" class="headerlink" title="YAML 语言"></a>YAML 语言</h2><h3 id="YAML-语言介绍"><a href="#YAML-语言介绍" class="headerlink" title="YAML 语言介绍"></a>YAML 语言介绍</h3><p>YAML：YAML Ain’t Markup Language，即YAML不是标记语言。不过，在开发的这种语言时，YAML的<br>意思其实是：”Yet Another Markup Language”（仍是一种标记语言）<br>YAML是一个可读性高的用来表达资料序列的格式。<br>YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。<br>Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者<br>目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等<br>YAML 官方网站：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.yaml.org</span><br></pre></td></tr></table></figure>

<p>ansible 官网:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html</span><br></pre></td></tr></table></figure>

<h3 id="YAML-语言特性"><a href="#YAML-语言特性" class="headerlink" title="YAML 语言特性"></a>YAML 语言特性</h3><ul>
<li>YAML的可读性好</li>
<li>YAML和脚本语言的交互性好</li>
<li>YAML使用实现语言的数据类型</li>
<li>YAML有一个一致的信息模型</li>
<li>YAML易于实现</li>
<li>YAML可以基于流来处理</li>
<li>YAML表达能力强，扩展性好</li>
</ul>
<h3 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h3><ul>
<li>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件结尾</li>
<li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li>
<li>使用#号注释代码</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结行来实现的</li>
<li>缩进不支持tab,必须使用空格进行缩进</li>
<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>
<li>YAML文件内容是区别大小写的，key&#x2F;value的值均需大小写敏感</li>
<li>多个key&#x2F;value可同行写也可换行写，同行使用，分隔</li>
<li>key后面冒号要加一个空格 比如: key: value</li>
<li>value可是个字符串，也可是另一个列表</li>
<li>YAML文件扩展名通常为yml或yaml</li>
</ul>
<h3 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h3><p>YAML 支持以下常用几种数据类型：</p>
<ul>
<li>标量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为: 字典（dictionary）&#x2F; 哈希（hashes） &#x2F; 映射（mapping）</li>
<li>数组：一组按次序排列的值，又称为: 列表（list）&#x2F; 序列（sequence）</li>
</ul>
<h4 id="scalar-标量"><a href="#scalar-标量" class="headerlink" title="scalar 标量"></a>scalar 标量</h4><p>key对应value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name: wang</span><br><span class="line">age: 18</span><br></pre></td></tr></table></figure>

<p>使用缩进的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name:</span><br><span class="line">wang</span><br><span class="line">age:</span><br><span class="line">18</span><br></pre></td></tr></table></figure>

<p>标量是最基本的，不可再分的值，包括：</p>
<ul>
<li>字符串 </li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
<h4 id="Dictionary-字典"><a href="#Dictionary-字典" class="headerlink" title="Dictionary 字典"></a>Dictionary 字典</h4><p>一个字典是由一个或多个key与value构成<br>key和value之间用冒号 ：分隔<br>冒号 : 后面有一个空格<br>所有 k&#x2F;v 可以放在一行，,每个 k&#x2F;v 之间用逗号分隔<br>所有每个 k&#x2F;v 也可以分别放在不同行,一对k&#x2F;v放在独立的一行<br>格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">account: &#123; name: wang, age: 30 &#125;</span><br></pre></td></tr></table></figure>
<p>使用缩进方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">account:</span><br><span class="line">name: wang</span><br><span class="line">age: 18</span><br></pre></td></tr></table></figure>
<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#不同行</span><br><span class="line"># An employee record</span><br><span class="line">name: Example Developer</span><br><span class="line">job: Developer</span><br><span class="line">skill: Elite(社会精英)</span><br><span class="line">#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span><br><span class="line"># An employee record</span><br><span class="line">&#123;name: &quot;Example Developer&quot;, job: &quot;Developer&quot;, skill: &quot;Elite&quot;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h4><p>列表由多个元素组成<br>每个元素放在不同行，每个元素一行,且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格<br>也可以将所有元素用 [ ] 括起来放在同一行,每个元素之间用逗号分隔<br>格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">course: [ linux , golang , python ]</span><br></pre></td></tr></table></figure>

<p>也可以写成以 - 开头的多行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">course:</span><br><span class="line">	- linux</span><br><span class="line">	- golang</span><br><span class="line">	- python</span><br><span class="line">course:</span><br><span class="line">	- linux: manjaro</span><br><span class="line">	- golang: gin</span><br><span class="line">	- python: django</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#不同行,行以-开头,后面有一个空格</span><br><span class="line"># A list of tasty fruits</span><br><span class="line">- Apple</span><br><span class="line">- Orange</span><br><span class="line">- Strawberry</span><br><span class="line">- Mango</span><br><span class="line">#同一行</span><br><span class="line">[Apple,Orange,Strawberry,Mango]</span><br></pre></td></tr></table></figure>

<p>范例：YAML 表示一个家庭</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">name: John Smith</span><br><span class="line">age: 41</span><br><span class="line">gender: Male</span><br><span class="line">spouse: &#123; name: Jane Smith, age: 37, gender: Female &#125; # 写在一行里</span><br><span class="line">	name: Jane Smith #也可以写成多行</span><br><span class="line">	age: 37</span><br><span class="line">	gender: Female</span><br><span class="line">	children: [ &#123;name: Jimmy Smith,age: 17, gender: Male&#125;, &#123;name: Jenny Smith, 		age:13, gender: Female&#125;, &#123;name: hao Smith, age: 20, gender: Male &#125; ] #写在一行</span><br><span class="line">	- name: Jimmy Smith #写在多行,更为推荐的写法</span><br><span class="line">		age: 17</span><br><span class="line">		gender: Male</span><br><span class="line">	- &#123;name: Jenny Smith, age: 13, gender: Female&#125;</span><br><span class="line">	- &#123;name: hao Smith, age: 20, gender: Male &#125;</span><br></pre></td></tr></table></figure>

<h3 id="三种常见的数据格式"><a href="#三种常见的数据格式" class="headerlink" title="三种常见的数据格式"></a>三种常见的数据格式</h3><ul>
<li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li>
<li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li>
<li>YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</li>
</ul>
<p><img src="/../image.assets/1677310138888.png" alt="1677310138888"></p>
<p>可以用工具互相转换，参考网站：<br><a target="_blank" rel="noopener" href="https://www.json2yaml.com/">https://www.json2yaml.com/</a><br><a target="_blank" rel="noopener" href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p>
<h2 id="Playbook-核心组件"><a href="#Playbook-核心组件" class="headerlink" title="Playbook 核心组件"></a>Playbook 核心组件</h2><p>官方文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#playbook-keywords</span><br></pre></td></tr></table></figure>
<p>一个playbook 中由多个组件组成,其中所用到的常见组件类型如下:</p>
<ul>
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需少元素需包括 name 和 task,一个name只能包括一个task</li>
<li>Variables 内置变量或自定义变量在playbook中调用</li>
<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>
<li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此 会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</li>
</ul>
<h3 id="hosts-组件"><a href="#hosts-组件" class="headerlink" title="hosts 组件"></a>hosts 组件</h3><p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">one.example.com</span><br><span class="line">one.example.com:two.example.com</span><br><span class="line">192.168.1.50</span><br><span class="line">192.168.1.*</span><br><span class="line">Websrvs:dbsrvs #或者，两个组的并集</span><br><span class="line">Websrvs:&amp;dbsrvs #与，两个组的交集</span><br><span class="line">webservers:!dbsrvs #在websrvs组，但不在dbsrvs组</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs:appsrvs</span><br></pre></td></tr></table></figure>

<h3 id="remote-user-组件"><a href="#remote-user-组件" class="headerlink" title="remote_user 组件"></a>remote_user 组件</h3><p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: test connection</span><br><span class="line">    ping:</span><br><span class="line">    remote_user: magedu</span><br><span class="line">    sudo: yes #默认sudo为root</span><br><span class="line">    sudo_user:wang #sudo为wang</span><br></pre></td></tr></table></figure>

<h3 id="task列表和action组件"><a href="#task列表和action组件" class="headerlink" title="task列表和action组件"></a>task列表和action组件</h3><p>play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task<br>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br>每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。<br>如果未提供name，则action的结果将用于输出<br>task两种格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">action: module arguments #示例: action: shell wall hello</span><br><span class="line">module: arguments #建议使用 #示例: shell: wall hello</span><br></pre></td></tr></table></figure>

<p>注意：shell和command模块后面跟命令，而非key&#x3D;value<br>范例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]#cat hello.yml</span><br><span class="line">---</span><br><span class="line">#first yaml文件</span><br><span class="line">#</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: task1</span><br><span class="line">      debug: msg=&quot;task1 running&quot;</span><br><span class="line">    - name: task2</span><br><span class="line">      debug: msg=&quot;task2 running&quot;</span><br><span class="line">- hosts: appsrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: task3</span><br><span class="line">      debug: msg=&quot;task3 running&quot;</span><br><span class="line">    - name: task4</span><br><span class="line">      debug: msg=&quot;task4 running&quot;</span><br></pre></td></tr></table></figure>

<h3 id="其它组件说明"><a href="#其它组件说明" class="headerlink" title="其它组件说明"></a>其它组件说明</h3><p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers任务<br>还可以通过”tags”给task 打标签，可在ansible-playbook命令上使用-t指定进行调用</p>
<h3 id="ShellScripts-VS-Playbook-案例"><a href="#ShellScripts-VS-Playbook-案例" class="headerlink" title="ShellScripts VS Playbook 案例"></a>ShellScripts VS Playbook 案例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#SHELL脚本实现</span><br><span class="line">#!/bin/bash</span><br><span class="line"># 安装Apache</span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"># 复制配置文件</span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf</span><br><span class="line">cp/tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"># 启动Apache，并设置开机启动</span><br><span class="line">systemctl enable --now httpd</span><br><span class="line">#Playbook实现</span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">  - name: &quot;安装Apache&quot;</span><br><span class="line">    yum: name=httpd</span><br><span class="line">  - name: &quot;复制配置文件&quot;</span><br><span class="line">	copy: src=/tmp/httpd.conf dest=/etc/httpd/conf/</span><br><span class="line">  - name: &quot;复制配置文件&quot;</span><br><span class="line">	copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/</span><br><span class="line">  - name: &quot;启动Apache，并设置开机启动&quot;</span><br><span class="line">	service: name=httpd state=started enabled=yes</span><br></pre></td></tr></table></figure>

<h2 id="playbook-命令"><a href="#playbook-命令" class="headerlink" title="playbook 命令"></a>playbook 命令</h2><p>格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></pre></td></tr></table></figure>

<p>选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--syntax,--syntax-check #语法检查,功能相当于bash -n</span><br><span class="line">-C --check #模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作</span><br><span class="line">--list-hosts #列出运行任务的主机</span><br><span class="line">--list-tags #列出tag</span><br><span class="line">--list-tasks #列出task</span><br><span class="line">--limit 主机列表 #只针对主机列表中的特定主机执行</span><br><span class="line">-i INVENTORY, --inventory INVENTORY #指定主机清单文件,通常一个项对应一个主机清单文件</span><br><span class="line">--start-at-task START_AT_TASK #从指定task开始执行,而非从头开始,START_AT_TASK为任务的name</span><br><span class="line">-v -vv -vvv #显示过程</span><br></pre></td></tr></table></figure>

<p>范例: 一个简单的 playbook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]#cat hello.yml</span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello</span><br><span class="line">      command: echo &quot;hello ansible&quot;</span><br><span class="line">[root@ansible ansible]#ansible-playbook hello.yml</span><br><span class="line">[root@ansible ansible]#ansible-playbook -v hello.yml</span><br></pre></td></tr></table></figure>

<p>范例: 检查和限制主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook file.yml --check #只检测</span><br><span class="line">ansible-playbook file.yml</span><br><span class="line">ansible-playbook file.yml --limit websrvs</span><br></pre></td></tr></table></figure>

<p>范例: 一个playbook 多个play</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat test_plays.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: localhost</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: play1</span><br><span class="line">      command: echo &quot;play1&quot;</span><br><span class="line">- hosts: centos7</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: play2</span><br><span class="line">      command: echo &quot;play2&quot;</span><br></pre></td></tr></table></figure>

<h2 id="忽略错误-ignore-errors"><a href="#忽略错误-ignore-errors" class="headerlink" title="忽略错误 ignore_errors"></a>忽略错误 ignore_errors</h2><p>如果一个task出错,默认将不会继续执行后续的其它task<br>利用 ignore_errors: yes 可以忽略此task的错误,继续向下执行playbook其它task</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]#cat test_ignore.yml</span><br><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">    - name: error</span><br><span class="line">      command: /bin/false</span><br><span class="line">      ignore_errors: yes</span><br><span class="line">    - name: continue</span><br><span class="line">      command: wall continue</span><br></pre></td></tr></table></figure>

<h2 id="Playbook中使用handlers和notify"><a href="#Playbook中使用handlers和notify" class="headerlink" title="Playbook中使用handlers和notify"></a>Playbook中使用handlers和notify</h2><h3 id="handlers和notify"><a href="#handlers和notify" class="headerlink" title="handlers和notify"></a>handlers和notify</h3><p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。<br>Notify对应的action 在所有task都执行完才会最后被触发，这样可避免多个task多次改变发生时每次都触发执行指定的操作，Handlers仅在所有的变化发生完成后一次性地执行指定操作。<br>在notify中列出的操作称为handler，也即notify中调用handler中定义的操作<br>注意:</p>
<ul>
<li>如果多个task通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。</li>
<li>只有notify对应的task发生改变了才会通知handlers， 没有改变则不会触发handlers</li>
<li>handlers 是在所有前面的tasks都成功执行才会执行,如果前面任何一个task失败,会导致handle跳过执行</li>
</ul>
<p>案例:</p>
<p><img src="/../image.assets/1677315798458.png" alt="1677315798458"></p>
<p><img src="/../image.assets/1677315812687.png" alt="1677315812687"></p>
<p>案例：</p>
<p><img src="/../image.assets/1677315839869.png" alt="1677315839869"></p>
<p>案例：</p>
<p><img src="/../image.assets/1677315862982.png" alt="1677315862982"></p>
<p><img src="/../image.assets/1677315872464.png" alt="1677315872464"></p>
<p>范例: 部署haproxy</p>
<p><img src="/../image.assets/1677315902745.png" alt="1677315902745"></p>
<h3 id="force-handlers"><a href="#force-handlers" class="headerlink" title="force_handlers"></a>force_handlers</h3><p>如果不论前面的task成功与否,都希望handlers能执行, 可以使用force_handlers: yes 强制执行handler<br>范例: 强制调用handlers</p>
<p><img src="/../image.assets/1677315975960.png" alt="1677315975960"></p>
<h2 id="Playbook中使用tags组件"><a href="#Playbook中使用tags组件" class="headerlink" title="Playbook中使用tags组件"></a>Playbook中使用tags组件</h2><p>官方文档:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html</span><br></pre></td></tr></table></figure>

<p>默认情况下， Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务，在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件<br>可以一个task对应多个tag,也可以多个task对应同一个tag<br>还有另外3个特殊关键字用于标签, tagged, untagged 和 all,它们分别是仅运行已标记，只有未标记和所有任务。<br>tags 主要用于调试环境<br>范例： tag 标签</p>
<p><img src="/../image.assets/1677316033321.png" alt="1677316033321"></p>
<h2 id="Playbook中使用变量"><a href="#Playbook中使用变量" class="headerlink" title="Playbook中使用变量"></a>Playbook中使用变量</h2><p>Playbook中同样也支持变量<br>变量名：仅能由字母、数字和下划线组成，且只能以字母开头<br>变量定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variable=value</span><br><span class="line">variable: value</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_port=80</span><br><span class="line">http_port: 80</span><br></pre></td></tr></table></figure>

<p>通过  调用变量，且变量名前后建议加空格，有时用”“才生效<br>变量来源：</p>
<ol>
<li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li>
<li>通过命令行指定变量，优先级最高</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -e varname=value test.yml</span><br></pre></td></tr></table></figure>

<p>3.在playbook文件中定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">var1: value1</span><br><span class="line">var2: value2</span><br></pre></td></tr></table></figure>

<p>4.在独立的变量YAML文件中定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">vars_files:</span><br><span class="line">- vars.yml</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在主机清单文件中定义<br>主机（普通）变量：主机组中主机单独定义，优先级高于公共变量<br>组（公共）变量：针对主机组中所有主机定义统一变量</li>
<li>在项目中针对主机和主机组定义<br>在项目目录中创建 host_vars和group_vars目录</li>
<li>在role中定义</li>
</ol>
<p>变量的优先级从高到低如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-e 选项定义变量 --&gt;playbook中vars_files --&gt; playbook中vars变量定义 --&gt;host_vars/主机名文件 --&gt;主机清单中主机变量--&gt; group_vars/主机组名文件--&gt;group_vars/all文件--&gt; 主机清单组变量</span><br></pre></td></tr></table></figure>

<h3 id="使用-setup-模块中变量"><a href="#使用-setup-模块中变量" class="headerlink" title="使用 setup 模块中变量"></a>使用 setup 模块中变量</h3><h4 id="使用-facts-变量"><a href="#使用-facts-变量" class="headerlink" title="使用 facts 变量"></a>使用 facts 变量</h4><p>本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中<br>facts 包括的信息很多,如: 主机名,IP,CPU,内存,网卡等<br>facts 变量的实际使用场景案例</p>
<ul>
<li>通过facts变量获取被控端CPU的个数信息,从而生成不同的Nginx配置文件</li>
<li>通过facts变量获取被控端内存大小信息,从而生成不同的memcached的配置文件</li>
<li>通过facts变量获取被控端主机名称信息,从而生成不同的Zabbix配置文件</li>
<li>通过facts变量获取被控端网卡信息,从而生成不同的主机名</li>
</ul>
<p>案例：使用setup变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# ansible localhost -m setup -a &#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br><span class="line">localhost | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_default_ipv4&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;192.168.32.133&quot;,</span><br><span class="line">            &quot;alias&quot;: &quot;ens160&quot;,</span><br><span class="line">            &quot;broadcast&quot;: &quot;192.168.32.255&quot;,</span><br><span class="line">            &quot;gateway&quot;: &quot;192.168.32.2&quot;,</span><br><span class="line">            &quot;interface&quot;: &quot;ens160&quot;,</span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:7c:80:cd&quot;,</span><br><span class="line">            &quot;mtu&quot;: 1500,</span><br><span class="line">            &quot;netmask&quot;: &quot;255.255.255.0&quot;,</span><br><span class="line">            &quot;network&quot;: &quot;192.168.32.0&quot;,</span><br><span class="line">            &quot;prefix&quot;: &quot;24&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">[root@ansible ~]# </span><br></pre></td></tr></table></figure>

<p>范例：显示ens33的网卡的IP地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">    - name: show ens33 ip</span><br><span class="line">      debug:</span><br><span class="line">        msg: IP address &#123;&#123; ansible_ens33.ipv4.address &#125;&#125;</span><br><span class="line">        #msg: IP address &#123;&#123; ansible_facts[&quot;ens33&quot;][&quot;ipv4&quot;][&quot;address&quot;] &#125;&#125;</span><br><span class="line">        #msg: IP address &#123;&#123; ansible_facts.ens33.ipv4.address &#125;&#125;</span><br><span class="line">        #msg: IP address &#123;&#123; ansible_default_ipv4.address &#125;&#125;</span><br><span class="line">        #msg: IP address &#123;&#123; ansible_ens33.ipv4.address &#125;&#125;</span><br><span class="line">        #msg: IP address &#123;&#123; ansible_ens33.ipv4.address.split(&#x27;.&#x27;)[-1] &#125;&#125;  #取IP中的最后一个数字</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]# ansible-playbook -v show_ip.yml </span><br><span class="line">Using /etc/ansible/ansible.cfg as config file</span><br><span class="line"></span><br><span class="line">PLAY [centos7] *************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************</span><br><span class="line">ok: [192.168.32.179]</span><br><span class="line">ok: [192.168.32.178]</span><br><span class="line"></span><br><span class="line">TASK [show ens33 ip] *******************************************************************************************************************</span><br><span class="line">ok: [192.168.32.178] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;IP address 192.168.32.178&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.32.179] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;IP address 192.168.32.179&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************</span><br><span class="line">192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">[root@ansible ansible]# </span><br></pre></td></tr></table></figure>

<p>范例：修改主机名称为web-IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 打印facts变量</span><br><span class="line">    debug: msg=&#123;&#123; ansible_ens33.ipv4.address &#125;&#125;</span><br><span class="line">  - name: 修改主机名</span><br><span class="line">    hostname: name=web-&#123;&#123; ansible_ens33.ipv4.address &#125;&#125;</span><br><span class="line">  #- name: 获取facts变量提取IP地址，以.结尾的最后一列,修改主机名为web-hostid</span><br><span class="line">    #hostname: name=web-&#123;&#123; ansible_ens33.ipv4.address.split(&#x27;.&#x27;)[-1] &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]# ansible-playbook change_hostname.yml </span><br><span class="line"></span><br><span class="line">PLAY [centos7] *************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************</span><br><span class="line">ok: [192.168.32.178]</span><br><span class="line">ok: [192.168.32.179]</span><br><span class="line"></span><br><span class="line">TASK [打印facts变量] *******************************************************************************************************************</span><br><span class="line">ok: [192.168.32.178] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;192.168.32.178&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.32.179] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;192.168.32.179&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [修改主机名] **********************************************************************************************************************</span><br><span class="line">changed: [192.168.32.179]</span><br><span class="line">changed: [192.168.32.178]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************</span><br><span class="line">192.168.32.178             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">192.168.32.179             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">[root@ansible ansible]# </span><br></pre></td></tr></table></figure>

<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><p>每次执行playbook,默认会收集每个主机的所有facts变量,将会导致速度很慢,可以采用下面方法加速<br>方法1<br>关闭facts采集加速执行,此方法将导致无法使用facts变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br></pre></td></tr></table></figure>

<p>方法2<br>当使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置facts 的缓存,将facts变量信息存在redis服务器中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# cat /etc/ansible/ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line"># smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts</span><br><span class="line"># implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False</span><br><span class="line"># explicit 则表示默认不收集，要显式收集，必须使用gather_facts: True</span><br><span class="line">gathering = smart #在使用 facts 缓存时设置为smart</span><br><span class="line">fact_caching_timeout = 86400 #缓存时长</span><br><span class="line">fact_caching = redis #缓存存在redis中</span><br><span class="line">fact_caching_connection = 10.0.0.100:6379:0 #0表示redis的0号数据库</span><br><span class="line">#若redis设置了密码</span><br><span class="line">fact_caching_connection = 10.0.0.100:6379:0:password</span><br></pre></td></tr></table></figure>

<h3 id="register-注册变量"><a href="#register-注册变量" class="headerlink" title="register 注册变量"></a>register 注册变量</h3><p>在playbook中可以使用register将捕获命令的输出保存在临时变量中，方便后续调用此变量,比如可以使用debug模块进行显示输出<br>范例: 利用debug 模块输出变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get variable</span><br><span class="line">      shell: hostname</span><br><span class="line">      register: name</span><br><span class="line">    - name: print variable</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; name &#125;&#125;&quot; #输出register注册的name变量的全部信息,注意变量要加&quot; &quot;引起来</span><br><span class="line">         #msg: &quot;&#123;&#123; name.cmd &#125;&#125;&quot; #显示命令</span><br><span class="line">         #msg: &quot;&#123;&#123; name.rc &#125;&#125;&quot; #显示命令成功与否</span><br><span class="line">		 #msg: &quot;&#123;&#123; name.stdout &#125;&#125;&quot; #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出</span><br><span class="line">	    #msg: &quot;&#123;&#123; name.stdout_lines &#125;&#125;&quot; #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示</span><br><span class="line">		#msg: &quot;&#123;&#123; name[&#x27;stdout_lines&#x27;] &#125;&#125;&quot; #显示命令的执行结果为列表形式,和效果上面相同</span><br><span class="line">		#msg: &quot;&#123;&#123; name.stdout_lines[0] &#125;&#125;&quot; #显示命令的输出结果的列表中的第一个元素</span><br><span class="line">#说明 第一个 task 中，使用了 register 注册变量名为 name ；当 shell 模块执行完毕后，会将数据放到该变量中。第二给 task 中，使用了 debug 模块，并从变量name中获取数据。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]# ansible-playbook -C register.yml </span><br><span class="line"></span><br><span class="line">PLAY [centos7] *************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************</span><br><span class="line">ok: [192.168.32.179]</span><br><span class="line">ok: [192.168.32.178]</span><br><span class="line"></span><br><span class="line">TASK [get variable] ********************************************************************************************************************</span><br><span class="line">skipping: [192.168.32.179]</span><br><span class="line">skipping: [192.168.32.178]</span><br><span class="line"></span><br><span class="line">TASK [print variable] ******************************************************************************************************************</span><br><span class="line">ok: [192.168.32.178] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: false,</span><br><span class="line">        &quot;cmd&quot;: &quot;hostname&quot;,</span><br><span class="line">        &quot;delta&quot;: null,</span><br><span class="line">        &quot;end&quot;: null,</span><br><span class="line">        &quot;failed&quot;: false,</span><br><span class="line">        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,</span><br><span class="line">        &quot;rc&quot;: 0,</span><br><span class="line">        &quot;skipped&quot;: true,</span><br><span class="line">        &quot;start&quot;: null,</span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">        &quot;stderr_lines&quot;: [],</span><br><span class="line">        &quot;stdout&quot;: &quot;&quot;,</span><br><span class="line">        &quot;stdout_lines&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.32.179] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: false,</span><br><span class="line">        &quot;cmd&quot;: &quot;hostname&quot;,</span><br><span class="line">        &quot;delta&quot;: null,</span><br><span class="line">        &quot;end&quot;: null,</span><br><span class="line">        &quot;failed&quot;: false,</span><br><span class="line">        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,</span><br><span class="line">        &quot;rc&quot;: 0,</span><br><span class="line">        &quot;skipped&quot;: true,</span><br><span class="line">        &quot;start&quot;: null,</span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">        &quot;stderr_lines&quot;: [],</span><br><span class="line">        &quot;stdout&quot;: &quot;&quot;,</span><br><span class="line">        &quot;stdout_lines&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************</span><br><span class="line">192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">[root@ansible ansible]# </span><br></pre></td></tr></table></figure>

<p>范例: 安装启动服务并检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  vars:</span><br><span class="line">    package_name: nginx</span><br><span class="line">    service_name: nginx</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install &#123;&#123; package_name &#125;&#125;</span><br><span class="line">    yum: name=&#123;&#123; package_name &#125;&#125;</span><br><span class="line">  - name: start &#123;&#123; service_name &#125;&#125;</span><br><span class="line">    service: name=&#123;&#123; service_name &#125;&#125; state=started enabled=yes</span><br><span class="line">  - name: check</span><br><span class="line">    shell: ps axu|grep &#123;&#123; service_name &#125;&#125;</span><br><span class="line">    register: check_service</span><br><span class="line">  - name: debug</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; check_service.stdout_lines &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>范例: 修改主机名形式为 web_&lt;随机字符&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">  - name: genarate random</span><br><span class="line">    shell:</span><br><span class="line">      cmd: openssl rand -base64 12 |tr -dc &#x27;[:alnum:]&#x27;</span><br><span class="line">    register:</span><br><span class="line">      num</span><br><span class="line">  - name: show random</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; num &#125;&#125;&quot;</span><br><span class="line">  - name: change hostname</span><br><span class="line">    hostname:</span><br><span class="line">      name: web-&#123;&#123; num.stdout &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 修改主机名形式为 web_随机数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- hosts: centos7</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 定义一个随机数，设定为变量，然后后续调用</span><br><span class="line">    shell: echo $((RANDOM%255))</span><br><span class="line">    register: web_number</span><br><span class="line">  - name: 使用debug输出变量结果</span><br><span class="line">    debug: msg=&#123;&#123; web_number &#125;&#125;</span><br><span class="line">  - name: 使用hostname模块将主机名修改为web_随机数</span><br><span class="line">    hostname: name=web_&#123;&#123; web_number.stdout &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 批量修改主机名为随机字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: centos7</span><br><span class="line">  vars:</span><br><span class="line">    host: web</span><br><span class="line">    domain: wang.org</span><br><span class="line">  tasks:</span><br><span class="line">  - name: get variable</span><br><span class="line">    shell: echo $RANDOM | md5sum | cut -c 1-8</span><br><span class="line">    register: get_random</span><br><span class="line">  - name: print variable</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; get_random.stdout &#125;&#125;&quot;</span><br><span class="line">  - name: set hostname</span><br><span class="line">    hostname: name=&#123;&#123; host &#125;&#125;-&#123;&#123; get_random.stdout &#125;&#125;.&#123;&#123; domain &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 批量修改主机名为IP最后1位数字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: centos7</span><br><span class="line">  vars:</span><br><span class="line">    host: web</span><br><span class="line">    domain: wang.org</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get variable</span><br><span class="line">      shell: hostname -I | awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class="line">      register: get_ip</span><br><span class="line">    - name: print variable</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; get_ip.stdout.split(&#x27;.&#x27;)[3] &#125;&#125;&quot;</span><br><span class="line">    - name: set hostname</span><br><span class="line">      hostname: name=&#123;&#123; host &#125;&#125;-&#123;&#123; get_ip.stdout.split(&#x27;.&#x27;)[3] &#125;&#125;.&#123;&#123; domain &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在-Playbook-命令行中定义变量"><a href="#在-Playbook-命令行中定义变量" class="headerlink" title="在 Playbook 命令行中定义变量"></a>在 Playbook 命令行中定义变量</h3><p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install nginx</span><br><span class="line">    yum: name=&#123;&#123; pkname &#125;&#125; state=present</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@ansible ~]#ansible-playbook -e pkname=nginx var2.yml</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#也可以将多个变量放在一个文件中</span><br><span class="line">[root@ansible ~]#cat vars</span><br><span class="line">pkname1: memcached</span><br><span class="line">pkname2: vsftpd</span><br><span class="line">[root@ansible ~]#vim var2.yml</span><br><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package &#123;&#123; pkname1 &#125;</span><br><span class="line">    yum: name=&#123;&#123; pkname1 &#125;&#125; state=present</span><br><span class="line">  - name: install package &#123;&#123; pkname2 &#125;</span><br><span class="line">    yum: name=&#123;&#123; pkname2 &#125;&#125; state=present</span><br><span class="line">[root@ansible ~]#ansible-playbook -e pkname1=memcached -e pkname2=httpd var2.yml</span><br><span class="line">[root@ansible ~]#ansible-playbook -e &#x27;@vars&#x27; var2.yml</span><br></pre></td></tr></table></figure>

<h3 id="在playbook文件中定义变量"><a href="#在playbook文件中定义变量" class="headerlink" title="在playbook文件中定义变量"></a>在playbook文件中定义变量</h3><p>此方式定义的是私有变量,即只能在当前playbook中使用,不能被其它Playbook共用<br>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    username: user1</span><br><span class="line">    groupname: group1</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create group &#123;&#123; groupname &#125;&#125;</span><br><span class="line">    group: name=&#123;&#123; groupname &#125;&#125; state=present</span><br><span class="line">  - name: create user &#123;&#123; username &#125;&#125;</span><br><span class="line">    user: name=&#123;&#123; username &#125;&#125; group=&#123;&#123; groupname &#125;&#125; state=present</span><br><span class="line">    </span><br><span class="line">[root@ansible ~]#ansible-playbook -e &quot;username=user2 groupname=group2&quot; var3.yml</span><br></pre></td></tr></table></figure>

<p>范例：变量的相互调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: centos7</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    collect_info: &quot;/data/test/&#123;&#123;ansible_default_ipv4[&#x27;address&#x27;]&#125;&#125;/&quot;</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create IP directory</span><br><span class="line">    file: name=&quot;&#123;&#123;collect_info&#125;&#125;&quot; state=directory</span><br></pre></td></tr></table></figure>

<h3 id="使用专用的公共的变量文件"><a href="#使用专用的公共的变量文件" class="headerlink" title="使用专用的公共的变量文件"></a>使用专用的公共的变量文件</h3><p>可以在一个独立的playbook文件中定义公共变量，在其它的playbook文件中可以引用变量文件中的变量<br>此方式比playbook中定义的变量优化级高</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim vars.yml</span><br><span class="line">---</span><br><span class="line"># variables file</span><br><span class="line">package_name: mariadb-server</span><br><span class="line">service_name: mariadb</span><br><span class="line"></span><br><span class="line">vim var5.yml</span><br><span class="line">---</span><br><span class="line">#install package and start service</span><br><span class="line">- hosts: dbsrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_files:</span><br><span class="line">  # 指定变量文件名</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package</span><br><span class="line">    yum: name=&#123;&#123; package_name &#125;&#125;</span><br><span class="line">    tags: install</span><br><span class="line">  - name: start service</span><br><span class="line">    service: name=&#123;&#123; service_name &#125;&#125; state=started enabled=yes</span><br></pre></td></tr></table></figure>

<h3 id="在主机清单中定义主机和主机组的变量"><a href="#在主机清单中定义主机和主机组的变量" class="headerlink" title="在主机清单中定义主机和主机组的变量"></a>在主机清单中定义主机和主机组的变量</h3><h4 id="所有项目的主机变量"><a href="#所有项目的主机变量" class="headerlink" title="所有项目的主机变量"></a>所有项目的主机变量</h4><p>在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用<br>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">www1.wang.org http_port=80 maxRequestsPerChild=808</span><br><span class="line">www2.wang.org http_port=8080 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>

<h4 id="所有项目的组（公共）变量"><a href="#所有项目的组（公共）变量" class="headerlink" title="所有项目的组（公共）变量"></a>所有项目的组（公共）变量</h4><p>在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量</p>
<p>案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[webservers:vars]</span><br><span class="line">http_port=80</span><br><span class="line">ntp_server=ntp.wang.org</span><br><span class="line">nfs_server=nfs.wang.org</span><br><span class="line">[all:vars]</span><br><span class="line"># --------- Main Variables ---------------</span><br><span class="line"># Cluster container-runtime supported: docker, containerd</span><br><span class="line">CONTAINER_RUNTIME=&quot;docker&quot;</span><br><span class="line"># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span><br><span class="line">CLUSTER_NETWORK=&quot;calico&quot;</span><br><span class="line"># Service proxy mode of kube-proxy: &#x27;iptables&#x27; or &#x27;ipvs&#x27;</span><br><span class="line">PROXY_MODE=&quot;ipvs&quot;</span><br><span class="line"># K8S Service CIDR, not overlap with node(host) networking</span><br><span class="line">SERVICE_CIDR=&quot;192.168.0.0/16&quot;</span><br><span class="line"># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span><br><span class="line">CLUSTER_CIDR=&quot;172.16.0.0/16&quot;</span><br><span class="line"># NodePort Range</span><br><span class="line">NODE_PORT_RANGE=&quot;20000-60000&quot;</span><br><span class="line"># Cluster DNS Domain</span><br><span class="line">CLUSTER_DNS_DOMAIN=&quot;magedu.local.&quot;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]#vim /etc/ansible/hosts</span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.8 hname=www1 domain=magedu.io</span><br><span class="line">10.0.0.7 hname=www2</span><br><span class="line">[webservers:vars]</span><br><span class="line">mark=&quot;-&quot;</span><br><span class="line">[all:vars]</span><br><span class="line">domain=wang.org</span><br><span class="line">[root@ansible ~]#ansible webservers -m hostname -a &#x27;name=&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;</span><br><span class="line">&#123;&#123; domain &#125;&#125;&#x27;</span><br><span class="line">#命令行指定变量：</span><br><span class="line">[root@ansible ~]#ansible webservers -e domain=magedu.cn -m hostname -a &#x27;name=</span><br><span class="line">&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; domain &#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="针对当前项目的主机和主机组的变量"><a href="#针对当前项目的主机和主机组的变量" class="headerlink" title="针对当前项目的主机和主机组的变量"></a>针对当前项目的主机和主机组的变量</h3><p>上面的方式是针对所有项目都有效,而官方更建议的方式是使用ansible特定项目的主机变量和组变量.生产建议在每个项目对应的目录中创建额外的两个变量目录,分别是host_vars和group_vars</p>
<ul>
<li>host_vars下面的文件名和主机清单主机名一致,针对单个主机进行变量定义格式:host_vars&#x2F;hostname</li>
<li>group_vars下面的文件名和主机清单中组名一致, 针对单个组进行变量定义格式: group_vars&#x2F;groupname</li>
<li>group_vars&#x2F;all文件内定义的变量对所有组都有效</li>
</ul>
<p>范例: 特定项目的主机和组变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ansible]#pwd</span><br><span class="line">/data/ansible</span><br><span class="line">[root@ansible ansible]#mkdir host_vars</span><br><span class="line">[root@ansible ansible]#mkdir group_vars</span><br><span class="line">[root@ansible ansible]#cat host_vars/10.0.0.8</span><br><span class="line">id: 2</span><br><span class="line">[root@ansible ansible]#cat host_vars/10.0.0.7</span><br><span class="line">id: 1</span><br><span class="line">[root@ansible ansible]#cat group_vars/webservers</span><br><span class="line">name: web</span><br><span class="line">[root@ansible ansible]#cat group_vars/all</span><br><span class="line">domain: wang.org</span><br><span class="line">[root@ansible ansible]#tree host_vars/ group_vars/</span><br><span class="line">host_vars/</span><br><span class="line">├── 10.0.0.7</span><br><span class="line">└── 10.0.0.8</span><br><span class="line">group_vars/</span><br><span class="line">├── all</span><br><span class="line">└── webservers</span><br><span class="line">0 directories, 4 files</span><br><span class="line">[root@ansible ansible]#cat test.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">tasks:</span><br><span class="line">- name: get variable</span><br><span class="line">command: echo &quot;&#123;&#123;name&#125;&#125;&#123;&#123;id&#125;&#125;.&#123;&#123;domain&#125;&#125;&quot;</span><br><span class="line">register: result</span><br><span class="line">- name: print variable</span><br><span class="line">debug:</span><br><span class="line">msg: &quot;&#123;&#123;result.stdout&#125;&#125;&quot;</span><br><span class="line">[root@ansible ansible]#ansible-playbook test.yml</span><br><span class="line">PLAY [webservers]</span><br><span class="line">********************************************************************************</span><br><span class="line">***************************************</span><br><span class="line">TASK [Gathering Facts]</span><br><span class="line">********************************************************************************</span><br><span class="line">*******************************</span><br><span class="line">ok: [10.0.0.7]</span><br><span class="line">ok: [10.0.0.8]</span><br><span class="line">TASK [get variable]</span><br><span class="line">********************************************************************************</span><br><span class="line">**********************************</span><br><span class="line">changed: [10.0.0.7]</span><br><span class="line">changed: [10.0.0.8]</span><br><span class="line">TASK [print variable]</span><br><span class="line">********************************************************************************</span><br><span class="line">********************************</span><br><span class="line">ok: [10.0.0.7] =&gt; &#123;</span><br><span class="line">&quot;msg&quot;: &quot;web1.wang.org&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.0.8] =&gt; &#123;</span><br><span class="line">&quot;msg&quot;: &quot;web2.wang.org&quot;</span><br><span class="line">&#125;</span><br><span class="line">PLAY RECAP</span><br><span class="line">********************************************************************************</span><br><span class="line">*******************************************</span><br><span class="line">10.0.0.7 : ok=3 changed=1 unreachable=0 failed=0</span><br><span class="line">skipped=0 rescued=0 ignored=0</span><br><span class="line">10.0.0.8 : ok=3 changed=1 unreachable=0 failed=0</span><br><span class="line">skipped=0 rescued=0 ignored=0</span><br></pre></td></tr></table></figure>


    </div>
    
    <div class="post-footer">
        <div>
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/2023/02/21/Ansible/" class="next-post btn btn-default" title='运维自动化工具Ansible(一)'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            运维自动化工具Ansible(一)</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
    
<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
    new Valine({
        av: AV,
        el: '#vcomments',
        appId: 'hQDROocUhxVs3CipuQjO33sY-gzGzoHsz',
        appKey: 'CHcmi9bz6KRRaChFJVSY14g1',
        placeholder: '说点什么吧',
        notify: false,
        verify: true,
        avatar: 'mm',
        meta: 'nick,mail'.split(','),
        pageSize: '10',
        path: window.location.pathname,
        lang: 'zh-CN'.toLowerCase()
    })
    </script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Playbook"><span class="toc-text">Playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#playbook%E4%BB%8B%E7%BB%8D"><span class="toc-text">playbook介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Playbook-%E7%BB%84%E6%88%90"><span class="toc-text">Playbook 组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Playbook-%E4%B8%8E-Ad-Hoc-%E5%AF%B9%E6%AF%94"><span class="toc-text">Playbook 与 Ad-Hoc 对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YAML-%E8%AF%AD%E8%A8%80"><span class="toc-text">YAML 语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YAML-%E8%AF%AD%E8%A8%80%E4%BB%8B%E7%BB%8D"><span class="toc-text">YAML 语言介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YAML-%E8%AF%AD%E8%A8%80%E7%89%B9%E6%80%A7"><span class="toc-text">YAML 语言特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YAML%E8%AF%AD%E6%B3%95%E7%AE%80%E4%BB%8B"><span class="toc-text">YAML语法简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">支持的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#scalar-%E6%A0%87%E9%87%8F"><span class="toc-text">scalar 标量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dictionary-%E5%AD%97%E5%85%B8"><span class="toc-text">Dictionary 字典</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#List-%E5%88%97%E8%A1%A8"><span class="toc-text">List 列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">三种常见的数据格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-text">Playbook 核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hosts-%E7%BB%84%E4%BB%B6"><span class="toc-text">hosts 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#remote-user-%E7%BB%84%E4%BB%B6"><span class="toc-text">remote_user 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task%E5%88%97%E8%A1%A8%E5%92%8Caction%E7%BB%84%E4%BB%B6"><span class="toc-text">task列表和action组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">其它组件说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShellScripts-VS-Playbook-%E6%A1%88%E4%BE%8B"><span class="toc-text">ShellScripts VS Playbook 案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#playbook-%E5%91%BD%E4%BB%A4"><span class="toc-text">playbook 命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E9%94%99%E8%AF%AF-ignore-errors"><span class="toc-text">忽略错误 ignore_errors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook%E4%B8%AD%E4%BD%BF%E7%94%A8handlers%E5%92%8Cnotify"><span class="toc-text">Playbook中使用handlers和notify</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#handlers%E5%92%8Cnotify"><span class="toc-text">handlers和notify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#force-handlers"><span class="toc-text">force_handlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook%E4%B8%AD%E4%BD%BF%E7%94%A8tags%E7%BB%84%E4%BB%B6"><span class="toc-text">Playbook中使用tags组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"><span class="toc-text">Playbook中使用变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setup-%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8F%98%E9%87%8F"><span class="toc-text">使用 setup 模块中变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-facts-%E5%8F%98%E9%87%8F"><span class="toc-text">使用 facts 变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">性能优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#register-%E6%B3%A8%E5%86%8C%E5%8F%98%E9%87%8F"><span class="toc-text">register 注册变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Playbook-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">在 Playbook 命令行中定义变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8playbook%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">在playbook文件中定义变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%93%E7%94%A8%E7%9A%84%E5%85%AC%E5%85%B1%E7%9A%84%E5%8F%98%E9%87%8F%E6%96%87%E4%BB%B6"><span class="toc-text">使用专用的公共的变量文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E4%B8%AD%E5%AE%9A%E4%B9%89%E4%B8%BB%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E7%BB%84%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">在主机清单中定义主机和主机组的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%BB%E6%9C%BA%E5%8F%98%E9%87%8F"><span class="toc-text">所有项目的主机变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%BB%84%EF%BC%88%E5%85%AC%E5%85%B1%EF%BC%89%E5%8F%98%E9%87%8F"><span class="toc-text">所有项目的组（公共）变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E5%BD%93%E5%89%8D%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%BB%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E7%BB%84%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">针对当前项目的主机和主机组的变量</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2022 - 2023
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>




<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>